#!/usr/bin/env python

# nxos-gatherfacts

import sys
import os
import json
import argparse

from aeon.nxos import NxosDevice
from aeon.exceptions import ProbeError, UnauthorizedError

psr = argparse.ArgumentParser(
    prog='nxos-gatherfacts',
    description="NXOS gather facts",
    add_help=True)

psr.add_argument(
    '-t', '--target',
    help='hostname or ip_addr of target device')

psr.add_argument(
    '-u', '--user',
    help='login user-name',
    default=os.getenv('AEON_USER'))

cli_args = psr.parse_args()

target = cli_args.target
user = cli_args.user
passwd = os.getenv('AEON_PASSWD')


def exit_results(results, exit_error=None):
    json.dump(results, fp=sys.stdout)
    sys.exit(0 if results['ok'] is True else exit_error or 1)

if not user:
    exit_results(dict(ok=False, message='Missing login user'))
if not passwd:
    exit_results(dict(ok=False, message='Missing login password'))


try:
    dev = NxosDevice(target, user=user, passwd=passwd)

except UnauthorizedError:
    exit_results(dict(
        ok=False,
        message='Uauthorized - check user/password'))

except ProbeError:
    exit_results(dict(
        ok=False,
        message='Failed to probe target %s' % target))

else:
    exit_results(dict(
        ok=True,
        facts=dict(
            os_version=dev.facts['os_version'],
            hw_model=dev.facts['hw_model'],
            serial_number=dev.facts['serial_number'])))
