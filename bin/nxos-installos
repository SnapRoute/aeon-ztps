#!/usr/bin/env python

# nxos-installos

import sys
import os
import json
import argparse

from aeon.nxos import NxosDevice
from aeon.exceptions import ProbeError, UnauthorizedError

psr = argparse.ArgumentParser(
    prog='nxos-installos',
    description="NXOS install OS",
    add_help=True)

psr.add_argument(
    '-t', '--target',
    help='hostname or ip_addr of target device')

psr.add_argument(
    '-u', '--user',
    help='login user-name',
    default=os.getenv('AEON_USER'))

psr.add_argument(
    '--image-profile',
    help='name of the image profile file')

g_cli_args = psr.parse_args()

target = g_cli_args.target
user = g_cli_args.user
passwd = os.getenv('AEON_PASSWD')


def exit_results(results, exit_error=None):
    json.dump(results, fp=sys.stdout)
    sys.exit(0 if results['ok'] is True else exit_error or 1)

if not user:
    exit_results(dict(ok=False, message='Missing login user'))
if not passwd:
    exit_results(dict(ok=False, message='Missing login password'))


def do_image_install(dev):
    pass

def main():
    try:
        dev = NxosDevice(target, user=user, passwd=passwd)

    except UnauthorizedError:
        exit_results(dict(
            ok=False,
            message='Uauthorized - check user/password'))

    except ProbeError:
        exit_results(dict(
            ok=False,
            message='Failed to probe target %s' % target))

    else:
        do_image_install(dev)

if '__main__' == __name__:
    main()